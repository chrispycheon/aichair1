<!DOCTYPE html>
<html>
<head>
  <title>블루투스 데이터 수신</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <button onclick="listBluetoothDevices()">블루투스 연결</button>
  <ul id="bluetooth-devices"></ul>
  <div id="chart"></div>
  <script>
    const bluetoothDevicesList = document.getElementById("bluetooth-devices");
    const chart = document.getElementById("chart");
    let dataArray = [];

    function listBluetoothDevices() {
      navigator.bluetooth.requestDevice({
        filters: [{ services: ["FFE0-0000-1000-00805F9B34FB"] }]
      })
      .then(device => {
        return device.gatt.connect();
      })
      .then(function(server) {
         return server.getPrimaryService("FFE0-0000-1000-00805F9B34FB");
        })
        .then(function(service) {
         return service.getCharacteristic("FFE1-0000-1000-00805F9B34FB");
        })
        .then(rxCharacteristic => {
        rxCharacteristic.addEventListener('characteristicvaluechanged', event => {
          const value = event.target.value;
          const dataView = new DataView(value.buffer);
          const number = dataView.getUint8(0);
          dataArray.push(number);
          plotData();
        });
        return rxCharacteristic.startNotifications();
      })
      .catch(error => {
        console.error(error);
      });
    }

    function plotData() {
      const x = [];
      const y = [];
      for (let i = 0; i < dataArray.length; i++) {
        x.push(i);
        y.push(dataArray[i]);
      }
      const trace = {
        x: x,
        y: y,
        type: 'scatter'
      };
      const layout = {
        title: '아두이노 데이터 그래프',
        xaxis: {title: '시간'},
        yaxis: {title: '데이터 값'}
      };
      Plotly.newPlot(chart, [trace], layout);
    }
  </script>
</body>
</html>
